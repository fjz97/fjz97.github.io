<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="feng&#39;s blog"/>
    

    <!--Author-->
    
        <meta name="author" content="feng"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="总结一下博客实现中的几个关键思路"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="feng&#39;s blog"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="冯京哲的狗窝"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://www.fengjingzhe.comhttps://res.cloudinary.com/bravey/image/upload/v1582873485/wallroom-2880x1620-bg-3cad5d2.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://www.fengjingzhe.comhttps://res.cloudinary.com/bravey/image/upload/v1582873485/wallroom-2880x1620-bg-3cad5d2.jpg"/>
    

    <!-- Title -->
    
    <title>总结一下博客实现中的几个关键思路 - 冯京哲的狗窝</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

<meta name="generator" content="Hexo 5.0.0"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">冯京哲的狗窝</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('https://res.cloudinary.com/bravey/image/upload/v1582873485/wallroom-2880x1620-bg-3cad5d2.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>总结一下博客实现中的几个关键思路</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2017-01-29
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/j2ee/">#j2ee</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/技术/">技术</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>总结一下博客实现过程中的几个重要思路和bug解决。</p>
<hr>
<h1 id="1-修改文章的时候如何让标题文章重新载入input和textarea"><a href="#1-修改文章的时候如何让标题文章重新载入input和textarea" class="headerlink" title="1.修改文章的时候如何让标题文章重新载入input和textarea"></a>1.修改文章的时候如何让标题文章重新载入input和textarea</h1><p>首先的想法是用js DOM来直接操作input和textarea的value属性（淦，突然发现ckeditor standard版居然没有改变颜色的功能……），这就首先要求js能获取到servlet或者说是jsp中的attribute，想到用el表达式可以，大概这么个想法：</p>
<pre><code>var title = document.getElementById(&quot;title&quot;);
title.value = $&amp;#123;modifyArticle.getTitle()&amp;#125;;</code></pre>
<p>但el表达式只是在html上进行简单的文本替换，也就是说，要想让${modifyArticle.getTitle()}成为字符串，得加上双引号，这样就有一个问题，如果el表达式中存在引号，那么字符串的生成就会出错。</p>
<p>后来仔细一想，直接在html的value属性里面加上不就可以了吗？因为html属性后面可以不加引号，就像这样：</p>
<pre><code>&lt;input class=&quot;form-control&quot; id=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;标题&quot; type=&quot;text&quot; value=&quot;$&amp;#123;modifyArticle.getTitle()&quot; /&gt;</code></pre>
<p>再仔细想，可以这样：</p>
<pre><code>&lt;textarea id=&quot;ckeditor&quot; name=&quot;content&quot;&gt;$&amp;#123;modifyArticle.getContent() &amp;#125;&lt;/textarea&gt;</code></pre>
<a id="more"></a>

<h1 id="2-实现二维码弹出小窗的效果"><a href="#2-实现二维码弹出小窗的效果" class="headerlink" title="2.实现二维码弹出小窗的效果"></a>2.实现二维码弹出小窗的效果</h1><p>这里用到了一个重要的css属性：z-index，表示元素的堆叠顺序。</p>
<p>在html中先占位两个div元素，分别表示二维码的区域和黑色关闭二维码区域。</p>
<pre><code>&lt;div id=&quot;light&quot; class=&quot;white_content&quot;&gt;
      &lt;img src=&quot;img/qrcode.jpg&quot; class=&quot;qrcode&quot; /&gt;
    &lt;/div&gt;
    &lt;div id=&quot;fade&quot; class=&quot;black_overlay&quot; onclick=&quot;closeWindow()&quot;&gt;&lt;/div&gt;</code></pre>
<p>关键看css属性：</p>
<pre><code>.black_overlay &amp;#123;
    display: none;
    position: absolute;
    top: 0%;
    left: 0%;
    width: 100%;
    height: 100%;
    background-color: black;
    z-index: 1001;
&amp;#125;

.white_content &amp;#123;
    display: none;
    position: absolute;
    height:500px;
    left: 37%;
    background-color: white;
    z-index: 1002;
&amp;#125;</code></pre>
<p>删去了一些无关紧要的大概就是以上样式。</p>
<p>两部分的display属性都是none，不做显示，而二维码部分的z-index属性要高，所以它在上面。</p>
<p>当点击了二维码的图标后，js函数将两部分的display属性全换成block块级显示，又因为黑色部分的四项属性决定了它占满全屏，就显示出了想要的效果。</p>
<h1 id="3-ckeditor配置"><a href="#3-ckeditor配置" class="headerlink" title="3.ckeditor配置"></a>3.ckeditor配置</h1><h2 id="1-上传图片"><a href="#1-上传图片" class="headerlink" title="1.上传图片"></a>1.上传图片</h2><p>ckeditor上传图片原理就是提交html form。大致流程为提交表单→服务器后端保存图片→js回调到编辑图片页。</p>
<p>先贴上服务器端代码：</p>
<pre><code>private String realPath = &quot;D:/resource/blog/images&quot;;
    private String urlPath = &quot;/resource/blog/images&quot;;
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException &amp;#123;
        // TODO Auto-generated method stub
        FileItemFactory factory = new DiskFileItemFactory();
        ServletFileUpload upload = new ServletFileUpload(factory);
        String fileUrl = null;
        try &amp;#123;
            List items = upload.parseRequest(request);
            Map fields = new HashMap();
            Iterator iter = items.iterator();
            while (iter.hasNext()) &amp;#123;
                FileItem item = (FileItem) iter.next();
                if (item.isFormField()) &amp;#123;
                    fields.put(item.getFieldName(), item.getString());
                &amp;#125; else &amp;#123;
                    fields.put(item.getFieldName(), item);
                &amp;#125;
            &amp;#125;

            FileItem upFile = (FileItem) fields.get(&quot;upload&quot;);

            //得到图片扩展名
            String fileNameLong = upFile.getName();
            fileNameLong = fileNameLong.replace(&#39;\\&#39;, &#39;/&#39;);
            String[] pathParts = fileNameLong.split(&quot;/&quot;);
            String fileName = pathParts[pathParts.length - 1];
            String ext = getExtension(fileName);

            //将图片以保存时间命名
            SimpleDateFormat fileFormatter = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;);
            Date dNow = new Date();
            fileName = fileFormatter.format(dNow) + &quot;.&quot; + ext;

            //创建图片文件
            File pathToSave = new File(realPath, fileName);
            pathToSave.createNewFile();

            //得到图片url
            fileUrl = urlPath + &quot;/&quot; + fileName;

            //写入图片文件
            upFile.write(pathToSave);

        &amp;#125; catch (Exception e) &amp;#123;
            e.printStackTrace();
        &amp;#125;
        PrintWriter out = response.getWriter();
        String callback = request.getParameter(&quot;CKEditorFuncNum&quot;);
        out.println(&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot;);
        out.println(&quot;window.parent.CKEDITOR.tools.callFunction(&quot; + callback + &quot;,&#39;&quot; + fileUrl + &quot;&#39;,&#39;&#39;&quot; + &quot;)&quot;);
        out.println(&quot;&lt;/script&gt;&quot;);
        out.flush();
        out.close();
    &amp;#125;</code></pre>
<p>这里用到了apache fileupload，要添加两个jar包。大致意思就是把提交的图片抽象成一个FileItem类。通过form中的name=”upload”，取到图片。</p>
<p>关键在于保存图片的路径，必须是绝对路径，相对路径根本创建不了文件，这里使用了两个路径，一个是图片的在服务器上的真实路径，另一个是图片在web服务器上的虚拟路径，前者用于创建并保存图片，后者用于回调和url访问。</p>
<p>最后通过一个ckeditor自带的js回调跳转到图片编辑页。</p>
<h2 id="2-编辑html源码"><a href="#2-编辑html源码" class="headerlink" title="2.编辑html源码"></a>2.编辑html源码</h2><p>二次编辑的时候，如果存在html源码，由于不明原因，会被ckeditor自动屏蔽，解决方法参考了<a target="_blank" rel="noopener" href="https://usolved.net/blog/post/ckeditor-converts-html-entities-to-angled-brackets%EF%BC%8C%E8%BF%99%E9%87%8C%E6%8A%8A%E5%8E%9F%E6%96%87%E8%B4%B4%E4%B8%8A%E6%9D%A5%EF%BC%9A">https://usolved.net/blog/post/ckeditor-converts-html-entities-to-angled-brackets，这里把原文贴上来：</a></p>
<blockquote>
<p>While trying out some syntax highlighting plugins for CKEditor (to start this new blog ;) ) I noticed that CKEditor has a problem when you like to display &lt; and &gt; (needed for code examples in HTML).</p>
</blockquote>
<blockquote>
<p>CKEditor handles angled brackets the right way when you create a new post and automatically converts them to their corresponding HTML entities &lt; and &gt;. But when you save the post to a database and load the content from a database (or JSON, etc.) back to CKEditor, all HTML entities for angled brackets (&lt; and &gt;) are converted back to &lt; and &gt;. So when you like to edit a post all the HTML examples are suddenly empty. </p>
</blockquote>
<blockquote>
<p>But there’s a workaround for this problem. Convert &amp; to &amp; in your backend before handing over the string to the textarea of CKEditor.</p>
<pre><code>//PHP example
$string = strtr($string, array(
&#39;&amp;lt;&#39; =&gt; &#39;&amp;amp;lt;&#39;,
&#39;&amp;gt;&#39; =&gt; &#39;&amp;amp;gt;&#39;,
));</code></pre>
</blockquote>
<p>```</p>
<blockquote>
<p>This bug exists for a while in CKEditor and is still not fixed (by the date of this blog post).</p>
</blockquote>
<h1 id="4-修改文章的思路"><a href="#4-修改文章的思路" class="headerlink" title="4.修改文章的思路"></a>4.修改文章的思路</h1><p>从article.jsp到ModifyServlet到insert.jsp到ModifyExecServlet</p>
<p>article.jsp通过URL参数传一个blog的id值，ModifyServlet获取到值后在数据库中查找这篇博客，获取到博客后，我在这里保存了五个值，前四个为ismodify(boolean),modifyTitle(String),modifyDate(String),modifyContent(String)，存在request对象中；最后一个为modifyId(int)，存在session对象中。</p>
<p>接着到了insert.jsp中，判断ismodify是否为true，是的话就把表单的提交处理改为modifyExecServlet，并把modifyTitle(String),modifyDate(String),modifyContent(String)显示出来，注意，这时这四个值就全部消亡了。</p>
<p>最后到了ModifyExecServlet，获取到提交的三个parameter和session中的id，对数据库进行修改。这里我没有removeAttribute，因为没必要，一切判断与这个属性无关，下次要用到它的时候直接覆盖。</p>
<p>在这之前我的方法是在session中只保存一个blog的属性，一切判断、获取都通过它，这样存在一个致命的bug：有这么一种情况，我点击了modify，跳转到了insert.jsp后，又改变主意回到主页去了，这时session中的blog属性就没被移除，我如果在这时候点击了insert，就是对上篇博客直接操作了。</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/klugjo/hexo-theme-clean-blog" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 feng<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>